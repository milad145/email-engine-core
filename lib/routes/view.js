import express from "express"import application from "../core/application.js";import {isLogin} from "../core/middleware.js"import {setResponseCode, setErrorResponse, decrypt} from "../utils/utility.js";import passport from "passport";let router = express.Router();//*********************** POST ***********************//router.post('/api/webhook', (req, res) => {    const {userId} = req.body.value[0];    return application.syncSubscription(userId)        .then(() => res.send(true))        .catch(err => setErrorResponse(req, res, err))});router.post("/sync-mails", isLogin, function (req, res) {    let {user} = req.session.passport;    let {folder} = req.body    application.syncMails(user._id, decrypt(user.accessToken), folder)        .then(() => res.send(true))        .catch(err => setErrorResponse(req, res, err))})//*********************** GET ***********************//router.get("/", isLogin, (req, res) => {    res.redirect('/profile')});router.get("/login", (req, res) => {    res.render('login')});router.get("/login-azure", passport.authenticate('azuread-openidconnect'));router.get("/azure-callback", passport.authenticate('azuread-openidconnect', {failureRedirect: '/'}),    (req, res) => {        let {user} = req.session.passport;        return application.syncMails(user._id, decrypt(user.accessToken), "all")            .catch(() => Promise.resolve())            .then(() => application.setupSubscriptionsWebhook(decrypt(user.accessToken)))            .catch(() => Promise.resolve())            .then(() => res.redirect('/'))    });router.get("/login-facebook", passport.authenticate("facebook"))router.get("/facebook-callback", passport.authenticate("facebook"), (req, res) => {    res.redirect("/")})router.get("/login-google", passport.authenticate("google"))router.get("/google-callback", passport.authenticate("google"), (req, res) => {    res.redirect("/")})router.get('/profile', isLogin, (req, res) => {    let {user} = req.session.passport;    return application.getProfileData(user._id)        .then(user => res.render('index', {page: 'profile', user}))        .catch(err => setErrorResponse(req, res, err))})router.get('/mails', isLogin, (req, res) => {    let {user} = req.session.passport;    let folder = 'all';    return application.getUserMails(user._id, folder)        .then(mails => res.render('index', {page: 'mails', folder, mails}))        .catch(err => setErrorResponse(req, res, err))})router.get('/mails/:folder', isLogin, (req, res) => {    let {user} = req.session.passport;    let {folder} = req.params    if (typeof folder === "string" && folder.length) {        return application.getUserMails(user._id, folder)            .then(mails => res.render('index', {page: 'mails',folder, mails}))            .catch(err => setErrorResponse(req, res, err))    } else        setResponseCode(req, res, 404)})router.get('/logout', (req, res) => {    // Clear user session    req.logout(() => {        req.session.destroy()        res.redirect("/")    });});export default router;